<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">

<style>
  # Needs to be here as it is not created as part of
  # the element, but by Quagga.

  video.drawingBuffer {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;

    width: 100%    !important;
    height: auto   !important;
  }
</style>

<dom-module id="write-dialog">
  <link rel="import" type="css" href="../../bower_components/paper-dialog-behavior/paper-dialog-common.css">
  <template>
    <style>
    :host {
      --paper-dialog-background-color: white;
    }

    h2 {
      font-size: 24px;
      font-weight: bold;
      padding-bottom: 16px
    }

    paper-button {
      color: var(--paper-indigo-500);
    }

    .buttons {
      border-top: 1px solid rgba(0, 0, 0, 0.12);
    }

    img {
      width: 100%;
    }

    video {
      width: 100%    !important;
      height: auto   !important;
    }
    </style>
    
    <h2>Create a new tag</h2>
    <paper-dialog-scrollable>
      <div id="interactive" class="viewport" style="background:url(/images/write-prepare.png) no-repeat; background-size:cover; height: 0px; padding-top: 75%; position:relative">
        <video class="fit"></video>
      </div>
      <p>
        Write the name of the shopping item to add, or write the UPC/EAN of the item to
        look up the name. You can also directly scan the barcode of the product.
      </p>
      <paper-input id="input" label="Item name or barcode numbers" value="{{value}}"
        autocapitalize maxlength="20">
      </paper-input>
      <br>
    </paper-dialog-scrollable>
    <div class="buttons">
      <paper-button on-tap="scan" disabled="{{!supportsBarcodeScanner}}">SCAN BARCODE</paper-button>
      <paper-button on-tap="action" disabled="{{!value}}">{{actionButtonText(isProductCode)}}</paper-button>
    </div>
  </template>
  
  <script src="../../bower_components/quagga/dist/quagga.min.js" type="text/javascript"></script>
  <script>
    (function() {
      'use strict';

      var dialog = null;

      Quagga.onProcessed(function(result) {
        return;
        var drawingCtx = Quagga.canvas.ctx.overlay,
            drawingCanvas = Quagga.canvas.dom.overlay;

        if (result) {
            if (result.boxes) {
                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                result.boxes.filter(function (box) {
                    return box !== result.box;
                }).forEach(function (box) {
                    Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                });
            }

            if (result.box) {
                Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
            }

            if (result.codeResult && result.codeResult.code) {
                Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
            }
        }
      });

      Quagga.onDetected(function(result) {
        var code = result.codeResult.code;
        if (dialog) {
          dialog.lookup(code);
        }

        Quagga.stop();
      });

      Polymer({
        is: 'write-dialog',
        behaviors: [
          Polymer.PaperDialogBehavior
        ],
        
        properties: {
          value: {
            type: String,
            value: '',
            notify: true
          },
          isProductCode: {
            type: Boolean,
            value: false,
            notify: true
          },
          supportsBarcodeScanner: {
            type: Boolean,
            value: false,
            notify: true
          }
        },

        ready: function() {
          dialog = this;
          this.$.input.addEventListener('input', this.inputChange.bind(this));

          navigator.webkitGetUserMedia({ video: true },
            () => { this.supportsBarcodeScanner = true },
            () => { this.supportsBarcodeScanner = false }
          );
        },

        inputChange: function(ev) {
          this.isProductCode = /^([0-9]*)$/.test(this.value);

          if (this.$.input.invalid) {
            this.$.input.invalid = false;
            this.$.input.errorMessage = '';
          }
        },

        actionButtonText: function(value) {
          return this.isProductCode ? 'LOOKUP' : 'ADD';
        },

        scan: function() {
          let size = this.$.interactive.getBoundingClientRect();

          Quagga.init(
            {
              inputStream: {
                type: 'LiveStream',
                constraints: {
                  video: { 
                    width: 640,
                    height: 480,
                    facingMode: {
                      exact: "environment"
                    }
                  }
                }
              },
              locator: {
                patchSize: 'medium',
                halfSample: true
              },
              numOfWorkers: 4,
              decoder: {
                readers : ['ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader']
              },
              locate: true
            }, function(err) {
              if (err) {
                console.log(err);
                return;
              }
              Quagga.start();
            });
        },

        lookup: function(value) {
          let key = '7a10574349051f0a4843d14c9b6ae14d';
          let id = value || this.value;

          this.$.input.invalid = false;

          fetch(`https://api.outpan.com/v2/products/${id}?apikey=${key}`, { })
            .then((response) => { return response.json(); })
            .then((json) => {
              if (!json.name) {
                throw Error;
              }
              this.value = json.name;
            })
            .catch(() => {
              this.$.input.invalid = true;
              this.$.input.errorMessage = 'Lookup failed, please try again.';
            });
        },

        action: function() {
          if (this.isProductCode) {
            this.lookup();
          } else {
            this.write();
          }
        },

        write: function() {
          if (!navigator.nfc) {
            this.fire('warn', { value: 'Failed to write; no WebNFC support'});
            this.toggle();
            return;
          }

          (() => {
            if (this.adapter) {
              return Promise.resolve(this.adapter);
            } else {
              return navigator.nfc.requestAdapter();
            }
          })().then((adapter) => {
            this.adapter = adapter;
            this.adapter.pushMessage([{ 
              kind: 'json', 
              type: 'application/json', 
              data: JSON.stringify({ name: this.value })
            }], { target: 'tag', timeout: 5 })
            .then(() => {
              this.fire('info', { value: 'Wrote ' + this.value });
              this.toggle();
            })
            .catch(() => {
              this.fire('warn', { value: 'Failed to write; unknown error' });
              this.toggle();
            });
          });
        }
      });
    })();
  </script>
  
</dom-module>
